<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Theiss Bendixen">
<meta name="dcterms.date" content="2025-08-24">

<title>Being Bayesian in a Frequentist World</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="bdb_blog_files/libs/clipboard/clipboard.min.js"></script>
<script src="bdb_blog_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="bdb_blog_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="bdb_blog_files/libs/quarto-html/popper.min.js"></script>
<script src="bdb_blog_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="bdb_blog_files/libs/quarto-html/anchor.min.js"></script>
<link href="bdb_blog_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="bdb_blog_files/libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="bdb_blog_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="bdb_blog_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="bdb_blog_files/libs/bootstrap/bootstrap-813c323200a87c37e262811031999de4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>
p { color: #555555; }
</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#we-need-some-data" id="toc-we-need-some-data" class="nav-link" data-scroll-target="#we-need-some-data">We need some data</a></li>
  <li><a href="#a-simple-bayesian-model" id="toc-a-simple-bayesian-model" class="nav-link" data-scroll-target="#a-simple-bayesian-model">A simple Bayesian model</a></li>
  <li><a href="#bayesian-dynamic-borrowing-model" id="toc-bayesian-dynamic-borrowing-model" class="nav-link" data-scroll-target="#bayesian-dynamic-borrowing-model">Bayesian dynamic borrowing model</a></li>
  <li><a href="#compare-models" id="toc-compare-models" class="nav-link" data-scroll-target="#compare-models">Compare models</a></li>
  <li><a href="#simulation-results" id="toc-simulation-results" class="nav-link" data-scroll-target="#simulation-results">Simulation results</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Being Bayesian in a Frequentist World</h1>
<p class="subtitle lead">A Brief Introduction to Bayesian Dynamic Borrowing in R</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Theiss Bendixen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 24, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 24, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this post, I’ll give a brief introduction to a Bayesian data analysis method known as “Bayesian dynamic borrowing” (BDB). BDB originated in biostatistics and in particular the clinical trials and drug development space.</p>
<p>In essence, BDB allows us to use informative priors, while letting the model figure out how much information to borrow from the prior. The model achieves this by estimating how similar the informative prior is to our current data.</p>
<p>This in turn has benefits on the operating characteristics of our analysis, such as balancing power gains with Type I error rates, something that drug regulatory agencies – as well as many parts of the scientific community writ large – care about. In that sense, BDB is a hybrid method, shoe-horning informative Bayesian inference into a frequentist framework. Put differently, it’s a way to be Bayesian in a frequentist world.</p>
<p>To follow along, I assume a basic familiarity with regression modeling and Bayesian statistics as well as with the <code>R</code> programming language <span class="citation" data-cites="rcoreteam2024">(<a href="#ref-rcoreteam2024" role="doc-biblioref">R Core Team 2024</a>)</span>.</p>
<p>Now, there are <em>many</em> different approaches to BDB – for one overview, see <span class="citation" data-cites="alt2025hdbayes">Alt et al. (<a href="#ref-alt2025hdbayes" role="doc-biblioref">2025</a>)</span>. We’re going to work with the so-called “commensurability parameter” approach following <span class="citation" data-cites="hobbs2011hierarchical">Hobbs et al. (<a href="#ref-hobbs2011hierarchical" role="doc-biblioref">2011</a>)</span>.</p>
</section>
<section id="we-need-some-data" class="level1">
<h1>We need some data</h1>
<p>First, we’ll need some data to work with. We’ll simulate data from a simple hypothetical randomized trial with <span class="math inline">\(N = 30\)</span>. For instance, we can imagine that this is an early-phase experimental weight management drug trial with an active group receiving the treatment and a control group receiving placebo. The outcome <code>y</code> is then percentage weight change since baseline, which we take to be normally distributed with some standard deviation (<code>true_sd</code>). We take the mean weight change in the control group to be -1% (it’s common to see a small mean weight loss even in the control group in these kinds of trials) and the treatment effect to be -4%.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>N_current <span class="ot">&lt;-</span> <span class="dv">30</span>  <span class="co"># current trial sample size</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">each=</span>N_current<span class="sc">/</span><span class="dv">2</span>)  <span class="co"># 0=control, 1=treatment</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># True effects</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>true_control_mean <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>true_treatment_effect <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>true_sd <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate outcomes</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_current, </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">mean =</span> true_control_mean <span class="sc">+</span> treatment<span class="sc">*</span>true_treatment_effect, </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">sd =</span> true_sd)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data list</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> treatment,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N_current</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="a-simple-bayesian-model" class="level1">
<h1>A simple Bayesian model</h1>
<p>Now, to build up toward implementing BDB, let’s first fit a simple Bayesian linear regression model to these data.</p>
<span class="math display">\[\begin{aligned}
    y_i &amp;\sim \text{Normal}(\mu_i, \sigma) \\
    \mu_i &amp;= \alpha + \beta x_i\\
    \alpha &amp;\sim \text{Normal}(0, 5) \\
    \beta &amp;\sim \text{Normal}(0, 5) \\
    \sigma &amp;\sim \text{Exponential}(0.5)
\end{aligned}\]</span>
<p>We model percentage weight change from baseline <span class="math inline">\(y_i\)</span> using a normal distribution with mean <span class="math inline">\(\mu\)</span> and standard deviation <span class="math inline">\(\sigma\)</span>. We model <span class="math inline">\(\mu\)</span> with a regression equation consisting of two terms: an intercept <span class="math inline">\(\alpha\)</span> and a slope <span class="math inline">\(\beta\)</span>. These represent the mean % weight change in the control group (when <span class="math inline">\(x_i = 0\)</span>) and the treatment effect (when <span class="math inline">\(x_i = 1\)</span>), respectively. The priors for <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\sigma\)</span> are weakly informative.</p>
<p>To fit this model, we’ll use the <code>rethinking</code> package <span class="citation" data-cites="mcelreath_statistical_2020">(<a href="#ref-mcelreath_statistical_2020" role="doc-biblioref">McElreath 2020</a>)</span>, an interface to <code>Stan</code> <span class="citation" data-cites="carpenter2017stan">(<a href="#ref-carpenter2017stan" role="doc-biblioref">Carpenter et al. 2017</a>)</span>, primarily because it’s a useful pedagogical tool. Contrary to other popular Bayesian packages, <code>rethinking</code> forces the user to be explicit about the model structure and prior distributions. In our actual day-to-day work, we might want to use the more convenient packages out there, but for learning (and teaching), the <code>rethinking</code> package is really unrivaled.</p>
<p>The <code>rethinking</code> package is also much more flexible. For instance, to my knowledge, you couldn’t fit a BDB model in popular Bayesian <code>R</code> software like <code>brms</code> <span class="citation" data-cites="burkner2017brms">(<a href="#ref-burkner2017brms" role="doc-biblioref">Bürkner 2017</a>)</span> and <code>rstanarm</code> <span class="citation" data-cites="rstanarm">(<a href="#ref-rstanarm" role="doc-biblioref">Goodrich et al. 2024</a>)</span>, at least not without some custom coding. There are, however, dedicated BDB packages out there which one could graduate to – see e.g., <span class="citation" data-cites="alt2025hdbayes">Alt et al. (<a href="#ref-alt2025hdbayes" role="doc-biblioref">2025</a>)</span>, <span class="citation" data-cites="psborrow2">Secrest and Gravestock (<a href="#ref-psborrow2" role="doc-biblioref">2025</a>)</span>, and <span class="citation" data-cites="rbest">Weber et al. (<a href="#ref-rbest" role="doc-biblioref">2021</a>)</span>.</p>
<p>Let me show what I mean. Here’s our Bayesian linear regression model as implemented in <code>rethinking</code> syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rethinking)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>model_noborrow <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">normal</span>(mu, sigma),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a <span class="sc">+</span> treatment<span class="sc">*</span>beta_trt,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    beta_trt <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">exponential</span>(<span class="fl">0.5</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">1000</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key bit is the content in <code>alist()</code>. We see that it corresponds very closely to the formal model just above. The remaining bits are the data and some Markov Chain Monte Carlo (MCMC) settings that we won’t go into details with here – see e.g. <span class="citation" data-cites="mcelreath_statistical_2020">McElreath (<a href="#ref-mcelreath_statistical_2020" role="doc-biblioref">2020</a>)</span> and <span class="citation" data-cites="bda3">Gelman et al. (<a href="#ref-bda3" role="doc-biblioref">2013</a>)</span>.</p>
</section>
<section id="bayesian-dynamic-borrowing-model" class="level1">
<h1>Bayesian dynamic borrowing model</h1>
<p>Let’s now imagine that we had historical data that we’d like to let inform our current trial analysis, for instance to increase power to detect a true effect – which in turn can help reduce sample size, cut costs, and shorten the duration of the trial. These data could come from a previous trial with a similar study population or from a meta-analysis of several trials. This prior information could also be elicited from domain experts.</p>
<p>I’m going to imagine that we have summary statistics from historical data on the control group that resembles in all relevant ways the control group in our current trial. Generally speaking, it’s the case that control group data is easier to come by, since different interventions (e.g., a new drug) may be tested against similar controls, whereas data on the specific intervention in question is more rare – after all, there’s a reason why we’re running the present study. That said, BDB can absolutely be used with historical treatment effect data, given data availability.</p>
<p>Similarly, I’ll illustrate BDB with the use of summary statistics from historical data, since summary statistics is also more widely available than individual-level data. But bear in mind that many BDB approaches can be used with (or even require) individual-level data.</p>
<p>For the sake of illustration, let’s imagine that the historical data on the control group, <span class="math inline">\(\alpha_h\)</span>, has a mean identical to the true control mean of our current data and a standard deviation, <span class="math inline">\(\sigma_h\)</span>, of 1. We add these values to our data list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>hist_control_mean <span class="ot">&lt;-</span> true_control_mean <span class="co"># no conflict btw. historical and current data</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>hist_control_sd <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">treatment =</span> treatment,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N_current,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add summary stats from historical data to data list</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">hist_control_mean =</span> hist_control_mean,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">hist_control_sd =</span> hist_control_sd</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll then modify our statistical model – I’ve highlighted the new bits.</p>
<span class="math display">\[\begin{aligned}
    \textcolor{grey}{y_i} &amp;{\; \textcolor{grey}{\sim}\; } \textcolor{grey}{\text{Normal}(\mu_i, \sigma)} \\
    \textcolor{grey}{\mu_i} &amp;{\; \textcolor{grey}{=}\; } \textcolor{grey}{\alpha + \beta x_i} \\
    \textcolor{black}{\alpha} &amp;{\; \textcolor{black}{\sim}\; } \textcolor{black}{\text{Normal}(\alpha_h, \sqrt{\sigma_h^2 + \frac{1}{\tau}})} \\
    \textcolor{grey}{\beta} &amp;{\; \textcolor{grey}{\sim}\; } \textcolor{grey}{\text{Normal}(0, 5)} \\
    \textcolor{grey}{\sigma} &amp;{\; \textcolor{grey}{\sim}\; } \textcolor{grey}{\text{Exponential}(0.5)} \\
    \textcolor{black}{\tau} &amp;{\; \textcolor{black}{\sim}\; } \textcolor{black}{\text{Exponential}(1)}
\end{aligned}\]</span>
<p>First, let’s look at the new prior on <span class="math inline">\(\alpha\)</span>. The prior is now centered on <span class="math inline">\(\alpha_h\)</span>, the mean derived from the historical control group data, instead of on 0.</p>
<p>But here’s the really cool bit. The standard deviation of the prior for <span class="math inline">\(\alpha\)</span> is now expressed as <span class="math inline">\(\sqrt{\sigma_h^2 + \frac{1}{\tau}}\)</span>. Let’s break it down. First, the term <span class="math inline">\(\sigma_h^2\)</span> is just the variance of the historical data.</p>
<p>The second part of the standard deviation, <span class="math inline">\(\frac{1}{\tau}\)</span>, reflects an extra layer of uncertainty in the prior that the model is free to adjust. It ensures that we don’t over-rely on historical data when it appears inconsistent with the current data. This is what makes dynamic borrowing <em>dynamic</em>. In a sense, we get two chances to get things right:</p>
<p>If the historical data aligns well with what we’re seeing in the current trial, the so-called “commensurability parameter” <span class="math inline">\(\tau\)</span> will tend toward larger values, which reduces the prior variance. This gives <span class="math inline">\(\alpha_h\)</span> more weight in influencing <span class="math inline">\(\alpha\)</span>, leading to greater borrowing of information. However, when there’s conflict between the historical data and the current trial data, the model can increase <span class="math inline">\(\frac{1}{\tau}\)</span>, effectively inflating the prior variance to down-weight the contribution of the historical data. This is a useful property, because it guards against borrowing too much information from an inappropriate prior.</p>
<p>We can think of <span class="math inline">\(\tau\)</span> in terms of shrinkage in a multilevel model, in that it controls the degree to which an estimate is “shrunk” toward a shared prior distribution, informed in this case by the historical data. Just as in a multilevel model, where shrinkage is guided by the variance of group-level parameters (with small variances pulling estimates closer to the group mean and large variances giving more freedom to individual group estimates), <span class="math inline">\(\tau\)</span> plays a similar role by dynamically adjusting the amount of borrowing from historical data.</p>
<p>And of course, <span class="math inline">\(\tau\)</span> needs a prior, too. The exponential distribution ensures that <span class="math inline">\(\tau\)</span> is positive, which is necessary since it’s formally a precision parameter. We’ve just set the rate of the distribution to 0.5 as a starting point, but since <span class="math inline">\(\tau\)</span> dictates the amount of borrowing, it’s a parameter that we — in a real analysis — need to play around with, for instance through sensitivity analysis (i.e., trying out different priors to make sure results are not inappropriately sensitive to our prior for <span class="math inline">\(\tau\)</span>).</p>
<p>Here’s how our BDB model could look in <code>rethinking</code>. Again, the syntax satisfyingly mimics the formal model – we can more or less simply program in the new priors for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\tau\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>model_bdb <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">normal</span>(mu, sigma),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a <span class="sc">+</span> treatment<span class="sc">*</span>beta_trt,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># new prior for alpha</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">normal</span>(hist_control_mean, <span class="fu">sqrt</span>(hist_control_sd<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>tau)),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    beta_trt <span class="sc">~</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">exponential</span>(<span class="fl">0.5</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tau parameter</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    tau <span class="sc">~</span> <span class="fu">exponential</span>(<span class="fl">0.5</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">1000</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare-models" class="level1">
<h1>Compare models</h1>
<p>Even though we’ve borrowed historical data for the control group, it’s ultimately the treatment effect we’re interested in. So let’s compare the posterior treatment effect estimates from the model with no borrowing against that of the BDB model.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>post_noborrow <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(model_noborrow)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>post_bdb <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(model_bdb)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame combining both posteriors</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta_trt =</span> <span class="fu">c</span>(post_noborrow<span class="sc">$</span>beta_trt, post_bdb<span class="sc">$</span>beta_trt),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"No borrowing"</span>, <span class="st">"BDB"</span>), </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">c</span>(<span class="fu">length</span>(post_noborrow<span class="sc">$</span>beta_trt), <span class="fu">length</span>(post_bdb<span class="sc">$</span>beta_trt)))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot!</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">y =</span> model, <span class="at">x =</span> beta_trt, <span class="at">slab_alpha =</span> <span class="fu">stat</span>(f))) <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_halfeye</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.width =</span> <span class="fl">0.95</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_interval =</span> <span class="st">"median_hdi"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalize =</span> <span class="st">"groups"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Treatment effect"</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bdb_blog_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see that the treatment effect estimate from the BDB model is indeed more precise than that of the no-borrowing model – although it’s hard to tell how much this increase in precision matters in practice. We turn to this question next.</p>
</section>
<section id="simulation-results" class="level1">
<h1>Simulation results</h1>
<p>To build some intuition for BDB, I’ve run a small simulation to see what happens under different scenarios. We explore statistical power and Type I error rate under four scenarios and a range of sample sizes:</p>
<p>“<em>No prior-data conflict</em>”: This is similar to above, where the mean of the historical control equals that of the control group of the current trial.</p>
<p>“<em>Prior-data conflict, same sign</em>”: The mean of the historical control is in conflict with – but has the same sign as – the control group and treatment effect of the current trial.</p>
<p>“<em>Prior-data conflict, opposite sign</em>”: The mean of the historical control is in conflict with – and has the opposite sign as – the control group and treatment effect of the current trial.</p>
<p>“<em>No prior-data conflict, wide SD</em>”: The mean of the historical control equals that of the control group of the current trial but the historical standard deviation is 5 times wider than in the example above.</p>
<p>We also vary the prior for <span class="math inline">\(\tau\)</span> to assess how sensitive the operating characteristics are to various prior exponential rates (0.1, 0.5, 1). For each combination of scenario, sample size, and <span class="math inline">\(\tau\)</span> prior, we run 2000 simulations.</p>
<p>While power and Type I errors are frequentist concepts, we can approximate them in a Bayesian framework.</p>
<p>For power, we can define a result as “significant” if the 95% quantile interval for the posterior distribution of the treatment effect excludes zero. We then calculate power as the proportion of simulations where the treatment effect is significant.</p>
<p>We approximate the Type I error rate by simulating datasets under the null, where the true treatment effect is zero. For each dataset, we fit the models and check whether the 95% quantile interval for the treatment effect excludes zero. The Type I error rate is then calculated as the proportion of these null simulations where the result is significant.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="do">#######################################</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="do">### Prepare treatment effect inputs </span><span class="al">###</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="do">#######################################</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># To avoid re-compiling the models on each simulation iteration</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="do">## First, compile the base models once with "dummy" data</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>n_dummy <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="do">### Dynamic borrowing model</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>base_model_dynamic_func <span class="ot">&lt;-</span> <span class="cf">function</span>(tau_prior) {</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alist</span>(</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      y <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      mu <span class="ot">&lt;-</span> a <span class="sc">+</span> treatment<span class="sc">*</span>beta_trt,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      a <span class="sc">~</span> <span class="fu">dnorm</span>(hist_control_mean, <span class="fu">sqrt</span>(hist_control_sd<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>tau)),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      beta_trt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="fl">0.5</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      tau <span class="sc">~</span> <span class="fu">dexp</span>(tau_prior)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">rnorm</span>(n_dummy), <span class="co"># dummy data for initial compilation</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">treatment =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">each =</span> n_dummy<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> n_dummy,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">hist_control_mean =</span> <span class="dv">0</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">hist_control_sd =</span> <span class="dv">1</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">tau_prior =</span> tau_prior</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">1000</span>,</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fit)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>base_model_dynamic <span class="ot">&lt;-</span> <span class="fu">base_model_dynamic_func</span>(<span class="at">tau_prior =</span> <span class="fl">0.5</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="do">### No borrowing model</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>base_model_noborrow <span class="ot">&lt;-</span> <span class="fu">ulam</span>(</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">alist</span>(</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> <span class="fu">dnorm</span>(mu, sigma),</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> a <span class="sc">+</span> treatment<span class="sc">*</span>beta_trt,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    beta_trt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">5</span>),</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">dexp</span>(<span class="dv">1</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rnorm</span>(n_dummy), <span class="co"># dummy data for initial compilation</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">each =</span> n_dummy<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> n_dummy</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">1000</span>,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="do">## Next, build the Stan models</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="do">### Get the Stan code from the compiled models</span></span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>dynamic_code <span class="ot">&lt;-</span> base_model_dynamic<span class="sc">@</span>model</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>noborrow_code <span class="ot">&lt;-</span> base_model_noborrow<span class="sc">@</span>model</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="do">### Replace dimensions with the variable N to allow varying sample sizes</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>dynamic_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"array</span><span class="sc">\\</span><span class="st">[20</span><span class="sc">\\</span><span class="st">]"</span>, <span class="st">"array[N]"</span>, dynamic_code)</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>dynamic_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"vector</span><span class="sc">\\</span><span class="st">[20</span><span class="sc">\\</span><span class="st">]"</span>, <span class="st">"vector[N]"</span>, dynamic_code_flexible)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>dynamic_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"1:20"</span>, <span class="st">"1:N"</span>, dynamic_code_flexible)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>noborrow_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"array</span><span class="sc">\\</span><span class="st">[20</span><span class="sc">\\</span><span class="st">]"</span>, <span class="st">"array[N]"</span>, noborrow_code)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>noborrow_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"vector</span><span class="sc">\\</span><span class="st">[20</span><span class="sc">\\</span><span class="st">]"</span>, <span class="st">"vector[N]"</span>, noborrow_code_flexible)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>noborrow_code_flexible <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"1:20"</span>, <span class="st">"1:N"</span>, noborrow_code_flexible)</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a><span class="do">### Compile the models</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>dynamic_model <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> dynamic_code_flexible)</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>noborrow_model <span class="ot">&lt;-</span> <span class="fu">stan_model</span>(<span class="at">model_code =</span> noborrow_code_flexible)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a><span class="do">### Function to simulate datasets</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>simulate_data <span class="ot">&lt;-</span> <span class="cf">function</span>(N_current,</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                          true_control_mean,</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>                          true_treatment_effect,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>                          true_sd,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                          <span class="at">seed =</span> <span class="cn">NULL</span>) {</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate data</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  treatment <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), <span class="at">each=</span>N_current<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_current,</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>             <span class="at">mean =</span> true_control_mean <span class="sc">+</span> treatment<span class="sc">*</span>true_treatment_effect,</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>             <span class="at">sd =</span> true_sd)</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> treatment</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a><span class="do">### Function to fit no-borrowing model</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>fit_noborrow <span class="ot">&lt;-</span> <span class="cf">function</span>(data, base_model_noborrow) {</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data list for no-borrow model</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>  data_noborrow <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> data<span class="sc">$</span>y,</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> data<span class="sc">$</span>treatment,</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">length</span>(data<span class="sc">$</span>y)</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit no borrow model</span></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>  fit_noborrow <span class="ot">&lt;-</span> <span class="fu">sampling</span>(noborrow_model,</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>                           <span class="at">data =</span> data_noborrow,</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>                           <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>                           <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>                           <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract posterior samples</span></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>  noborrow_post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fit_noborrow)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract posterior means</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>  noborrow_intercept_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(noborrow_post<span class="sc">$</span>a)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>  noborrow_treatment_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(noborrow_post<span class="sc">$</span>beta_trt)</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate significance</span></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>  noborrow_sig <span class="ot">&lt;-</span> <span class="fu">quantile</span>(noborrow_post<span class="sc">$</span>beta_trt, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> (noborrow_sig[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> noborrow_sig[<span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>      (noborrow_sig[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> noborrow_sig[<span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_mean =</span> noborrow_intercept_mean,</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_mean =</span> noborrow_treatment_mean</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a><span class="do">### Function to fit dynamic model</span></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>fit_dynamic <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>                        hist_control_mean,</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>                        hist_control_sd,</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>                        base_model_dynamic,</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>                        tau_prior) {</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create data list for dynamic model</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>  data_dynamic <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> data<span class="sc">$</span>y,</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment =</span> data<span class="sc">$</span>treatment,</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> <span class="fu">length</span>(data<span class="sc">$</span>y),</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean,</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau_prior =</span> tau_prior</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit dynamic model</span></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>  fit_dynamic <span class="ot">&lt;-</span> <span class="fu">sampling</span>(dynamic_model,</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> data_dynamic,</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>                          <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>                          <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>                          <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract posterior samples</span></span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>  dynamic_post <span class="ot">&lt;-</span> <span class="fu">extract.samples</span>(fit_dynamic)</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract posterior means</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>  dynamic_intercept_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(dynamic_post<span class="sc">$</span>a)</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>  dynamic_treatment_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(dynamic_post<span class="sc">$</span>beta_trt)</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate borrowing metrics</span></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>  mean_tau <span class="ot">&lt;-</span> <span class="fu">mean</span>(dynamic_post<span class="sc">$</span>tau)</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate significance</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>  dynamic_sig <span class="ot">&lt;-</span> <span class="fu">quantile</span>(dynamic_post<span class="sc">$</span>beta_trt, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> (dynamic_sig[<span class="dv">1</span>] <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> dynamic_sig[<span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|</span></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>      (dynamic_sig[<span class="dv">1</span>] <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> dynamic_sig[<span class="dv">2</span>] <span class="sc">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_tau =</span> mean_tau,</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept_mean =</span> dynamic_intercept_mean,</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">treatment_mean =</span> dynamic_treatment_mean</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to run simulation study</span></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>run_scenario_simulations <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_sizes, tau_priors, scenario_params, <span class="at">reuse_noborrow =</span> <span class="cn">FALSE</span>, <span class="at">stored_noborrow =</span> <span class="cn">NULL</span>) {</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Sample size: %d</span><span class="sc">\n</span><span class="st">"</span>, n))</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate all datasets for this sample size first</span></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>    simulated_datasets <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n_sims)</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims) {</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>      simulated_datasets[[i]] <span class="ot">&lt;-</span> <span class="fu">simulate_data</span>(</span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>        <span class="at">N_current =</span> n,</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_control_mean =</span> scenario_params<span class="sc">$</span>true_control_mean,</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_treatment_effect =</span> scenario_params<span class="sc">$</span>true_treatment_effect,</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>        <span class="at">true_sd =</span> scenario_params<span class="sc">$</span>true_sd,</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>        <span class="at">seed =</span> i</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit no-borrowing model if needed</span></span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>reuse_noborrow) {</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>      noborrow_results_i <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n_sims)</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims) {</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>        noborrow_results_i[[i]] <span class="ot">&lt;-</span> <span class="fu">fit_noborrow</span>(</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> simulated_datasets[[i]],</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>          <span class="at">base_model_noborrow =</span> base_model_noborrow</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">No-borrowing Progress: %d/%d simulations completed"</span>, i, n_sims))</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>      noborrow_results_i <span class="ot">&lt;-</span> stored_noborrow[[<span class="fu">as.character</span>(n)]]</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each tau prior, fit dynamic model using the same datasets</span></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(tau <span class="cf">in</span> tau_priors) {</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  Tau prior: %.1f</span><span class="sc">\n</span><span class="st">"</span>, tau))</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>      dynamic_results_i <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n_sims)</span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims) {</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>        dynamic_results_i[[i]] <span class="ot">&lt;-</span> <span class="fu">fit_dynamic</span>(</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> simulated_datasets[[i]],</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>          <span class="at">hist_control_mean =</span> scenario_params<span class="sc">$</span>hist_control_mean,</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>          <span class="at">hist_control_sd =</span> scenario_params<span class="sc">$</span>hist_control_sd,</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>          <span class="at">base_model_dynamic =</span> base_model_dynamic,</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>          <span class="at">tau_prior =</span> tau</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store results</span></span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>        results[[<span class="fu">length</span>(results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>          <span class="at">dynamic =</span> dynamic_results_i[[i]],</span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>          <span class="at">noborrow =</span> noborrow_results_i[[i]],</span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a>          <span class="at">sample_size =</span> n,</span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a>          <span class="at">tau_prior =</span> tau</span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\r</span><span class="st">Dynamic Progress: %d/%d simulations completed"</span>, i, n_sims))</span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a><span class="do">#######################</span></span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a><span class="do">### Run simulations </span><span class="al">###</span></span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a><span class="do">#######################</span></span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulation settings</span></span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="fl">2e3</span></span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a>sample_sizes <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">40</span>, <span class="dv">60</span>, <span class="dv">80</span>, <span class="dv">100</span>)</span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a>tau_priors <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)</span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Define scenario parameters</span></span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true" tabindex="-1"></a>true_control_mean <span class="ot">=</span> <span class="sc">-</span><span class="dv">1</span></span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true" tabindex="-1"></a>hist_control_mean <span class="ot">=</span> true_control_mean <span class="co"># no conflict</span></span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true" tabindex="-1"></a>hist_control_sd <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true" tabindex="-1"></a>true_treatment_effect <span class="ot">=</span> <span class="sc">-</span><span class="dv">4</span></span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true" tabindex="-1"></a>true_sd <span class="ot">=</span> <span class="dv">6</span></span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"If you updated the simulation parameters, did you also remember to update the prior in the model code?"</span>)</span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true" tabindex="-1"></a><span class="co"># List of scenarios</span></span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true" tabindex="-1"></a>scenarios_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">null_noconflict =</span> <span class="fu">list</span>(</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> <span class="dv">0</span>, <span class="co"># null hypothesis</span></span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean,  <span class="co"># no prior-data conflict</span></span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true" tabindex="-1"></a>  <span class="at">noconflict =</span> <span class="fu">list</span>(</span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> true_treatment_effect, <span class="co"># power</span></span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean,  <span class="co"># no prior-data conflict</span></span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true" tabindex="-1"></a>  <span class="at">null_conflict_oppsign =</span> <span class="fu">list</span>(</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> <span class="dv">0</span>, <span class="co"># null hypothesis</span></span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> <span class="fu">abs</span>(hist_control_mean) <span class="sc">+</span> <span class="dv">1</span>, <span class="co"># prior-data conflict</span></span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true" tabindex="-1"></a>  <span class="at">conflict_oppsign =</span> <span class="fu">list</span>(</span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> true_treatment_effect, <span class="co"># power</span></span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> <span class="fu">abs</span>(hist_control_mean) <span class="sc">+</span> <span class="dv">1</span>, <span class="co"># prior-data conflict</span></span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true" tabindex="-1"></a>  <span class="at">null_conflict_samesign =</span> <span class="fu">list</span>(</span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> <span class="dv">0</span>, <span class="co"># null hypothesis</span></span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean <span class="sc">-</span> <span class="dv">2</span>, <span class="co"># prior-data conflict</span></span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true" tabindex="-1"></a>  <span class="at">conflict_samesign =</span> <span class="fu">list</span>(</span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> true_treatment_effect, <span class="co"># power</span></span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean <span class="sc">-</span> <span class="dv">2</span>, <span class="co"># prior-data conflict</span></span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd,</span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true" tabindex="-1"></a>  <span class="at">null_noConflict_wideSE =</span> <span class="fu">list</span>(</span>
<span id="cb6-305"><a href="#cb6-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-306"><a href="#cb6-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> <span class="dv">0</span>, <span class="co"># null hypothesis</span></span>
<span id="cb6-307"><a href="#cb6-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean, <span class="co"># no prior-data conflict</span></span>
<span id="cb6-308"><a href="#cb6-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd <span class="sc">*</span> <span class="dv">5</span>, <span class="co"># wider historical data SE</span></span>
<span id="cb6-309"><a href="#cb6-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-310"><a href="#cb6-310" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb6-311"><a href="#cb6-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">noConflict_wideSE =</span> <span class="fu">list</span>(</span>
<span id="cb6-312"><a href="#cb6-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_control_mean =</span> true_control_mean,</span>
<span id="cb6-313"><a href="#cb6-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_treatment_effect =</span> true_treatment_effect, <span class="co"># power</span></span>
<span id="cb6-314"><a href="#cb6-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_mean =</span> hist_control_mean,  <span class="co"># no prior-data conflict</span></span>
<span id="cb6-315"><a href="#cb6-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">hist_control_sd =</span> hist_control_sd <span class="sc">*</span> <span class="dv">5</span>,  <span class="co"># wider historical data SE</span></span>
<span id="cb6-316"><a href="#cb6-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">true_sd =</span> true_sd</span>
<span id="cb6-317"><a href="#cb6-317" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-318"><a href="#cb6-318" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-319"><a href="#cb6-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Run all scenarios</span></span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true" tabindex="-1"></a>stored_noborrow <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-322"><a href="#cb6-322" aria-hidden="true" tabindex="-1"></a>scenarios <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-323"><a href="#cb6-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-324"><a href="#cb6-324" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> <span class="fu">names</span>(scenarios_params)) {</span>
<span id="cb6-325"><a href="#cb6-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Running %s simulations...</span><span class="sc">\n</span><span class="st">"</span>, scenario_name))</span>
<span id="cb6-326"><a href="#cb6-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-327"><a href="#cb6-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose sample sizes based on scenario type</span></span>
<span id="cb6-328"><a href="#cb6-328" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unblock to only run with one sample size for the null scenarios</span></span>
<span id="cb6-329"><a href="#cb6-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># current_sample_sizes &lt;- if(grepl("null", scenario_name)) c(20) else sample_sizes</span></span>
<span id="cb6-330"><a href="#cb6-330" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-331"><a href="#cb6-331" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine if we can reuse no-borrowing results</span></span>
<span id="cb6-332"><a href="#cb6-332" aria-hidden="true" tabindex="-1"></a>  scenario_type <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">grepl</span>(<span class="st">"null"</span>, scenario_name)) <span class="st">"null"</span> <span class="cf">else</span> <span class="st">"power"</span></span>
<span id="cb6-333"><a href="#cb6-333" aria-hidden="true" tabindex="-1"></a>  sample_size_key <span class="ot">&lt;-</span> <span class="fu">paste</span>(scenario_type, <span class="st">"n"</span>, <span class="at">sep=</span><span class="st">"_"</span>)</span>
<span id="cb6-334"><a href="#cb6-334" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-335"><a href="#cb6-335" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run simulations with appropriate handling of no-borrowing results</span></span>
<span id="cb6-336"><a href="#cb6-336" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(sample_size_key, <span class="at">where =</span> stored_noborrow)) {</span>
<span id="cb6-337"><a href="#cb6-337" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First time running this type of scenario (null or power)</span></span>
<span id="cb6-338"><a href="#cb6-338" aria-hidden="true" tabindex="-1"></a>    scenario_results <span class="ot">&lt;-</span> <span class="fu">run_scenario_simulations</span>(</span>
<span id="cb6-339"><a href="#cb6-339" aria-hidden="true" tabindex="-1"></a>      sample_sizes, </span>
<span id="cb6-340"><a href="#cb6-340" aria-hidden="true" tabindex="-1"></a>      tau_priors, </span>
<span id="cb6-341"><a href="#cb6-341" aria-hidden="true" tabindex="-1"></a>      scenarios_params[[scenario_name]],</span>
<span id="cb6-342"><a href="#cb6-342" aria-hidden="true" tabindex="-1"></a>      <span class="at">reuse_noborrow =</span> <span class="cn">FALSE</span></span>
<span id="cb6-343"><a href="#cb6-343" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-344"><a href="#cb6-344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-345"><a href="#cb6-345" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store no-borrowing results</span></span>
<span id="cb6-346"><a href="#cb6-346" aria-hidden="true" tabindex="-1"></a>    stored_noborrow[[sample_size_key]] <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-347"><a href="#cb6-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb6-348"><a href="#cb6-348" aria-hidden="true" tabindex="-1"></a>      n_results <span class="ot">&lt;-</span> scenario_results[<span class="fu">sapply</span>(scenario_results, <span class="cf">function</span>(x) x<span class="sc">$</span>sample_size <span class="sc">==</span> n)]</span>
<span id="cb6-349"><a href="#cb6-349" aria-hidden="true" tabindex="-1"></a>      stored_noborrow[[sample_size_key]][[<span class="fu">as.character</span>(n)]] <span class="ot">&lt;-</span> </span>
<span id="cb6-350"><a href="#cb6-350" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(n_results[<span class="dv">1</span><span class="sc">:</span>n_sims], <span class="cf">function</span>(x) x<span class="sc">$</span>noborrow)</span>
<span id="cb6-351"><a href="#cb6-351" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-352"><a href="#cb6-352" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-353"><a href="#cb6-353" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reuse existing no-borrowing results</span></span>
<span id="cb6-354"><a href="#cb6-354" aria-hidden="true" tabindex="-1"></a>    scenario_results <span class="ot">&lt;-</span> <span class="fu">run_scenario_simulations</span>(</span>
<span id="cb6-355"><a href="#cb6-355" aria-hidden="true" tabindex="-1"></a>      sample_sizes, </span>
<span id="cb6-356"><a href="#cb6-356" aria-hidden="true" tabindex="-1"></a>      tau_priors, </span>
<span id="cb6-357"><a href="#cb6-357" aria-hidden="true" tabindex="-1"></a>      scenarios_params[[scenario_name]],</span>
<span id="cb6-358"><a href="#cb6-358" aria-hidden="true" tabindex="-1"></a>      <span class="at">reuse_noborrow =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-359"><a href="#cb6-359" aria-hidden="true" tabindex="-1"></a>      <span class="at">stored_noborrow =</span> stored_noborrow[[sample_size_key]]</span>
<span id="cb6-360"><a href="#cb6-360" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-361"><a href="#cb6-361" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-362"><a href="#cb6-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-363"><a href="#cb6-363" aria-hidden="true" tabindex="-1"></a>  scenarios[[scenario_name]] <span class="ot">&lt;-</span> scenario_results</span>
<span id="cb6-364"><a href="#cb6-364" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-365"><a href="#cb6-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-366"><a href="#cb6-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Process results</span></span>
<span id="cb6-367"><a href="#cb6-367" aria-hidden="true" tabindex="-1"></a>results_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-368"><a href="#cb6-368" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> <span class="fu">names</span>(scenarios)) {</span>
<span id="cb6-369"><a href="#cb6-369" aria-hidden="true" tabindex="-1"></a>  scenario_results <span class="ot">&lt;-</span> scenarios[[scenario_name]]</span>
<span id="cb6-370"><a href="#cb6-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-371"><a href="#cb6-371" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First, group results by sample size and tau prior</span></span>
<span id="cb6-372"><a href="#cb6-372" aria-hidden="true" tabindex="-1"></a>  sample_sizes <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sapply</span>(scenario_results, <span class="cf">function</span>(x) x<span class="sc">$</span>sample_size))</span>
<span id="cb6-373"><a href="#cb6-373" aria-hidden="true" tabindex="-1"></a>  tau_priors <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">sapply</span>(scenario_results, <span class="cf">function</span>(x) x<span class="sc">$</span>tau_prior))</span>
<span id="cb6-374"><a href="#cb6-374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-375"><a href="#cb6-375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First process noborrow results</span></span>
<span id="cb6-376"><a href="#cb6-376" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb6-377"><a href="#cb6-377" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all results for this sample size</span></span>
<span id="cb6-378"><a href="#cb6-378" aria-hidden="true" tabindex="-1"></a>    noborrow_results <span class="ot">&lt;-</span> scenario_results[<span class="fu">sapply</span>(scenario_results, <span class="cf">function</span>(x) </span>
<span id="cb6-379"><a href="#cb6-379" aria-hidden="true" tabindex="-1"></a>      x<span class="sc">$</span>sample_size <span class="sc">==</span> n)]</span>
<span id="cb6-380"><a href="#cb6-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-381"><a href="#cb6-381" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate means across simulations for noborrow</span></span>
<span id="cb6-382"><a href="#cb6-382" aria-hidden="true" tabindex="-1"></a>    noborrow_significant <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(noborrow_results, <span class="cf">function</span>(x) x<span class="sc">$</span>noborrow<span class="sc">$</span>significant))</span>
<span id="cb6-383"><a href="#cb6-383" aria-hidden="true" tabindex="-1"></a>    noborrow_intercept <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(noborrow_results, <span class="cf">function</span>(x) x<span class="sc">$</span>noborrow<span class="sc">$</span>intercept_mean))</span>
<span id="cb6-384"><a href="#cb6-384" aria-hidden="true" tabindex="-1"></a>    noborrow_treatment <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(noborrow_results, <span class="cf">function</span>(x) x<span class="sc">$</span>noborrow<span class="sc">$</span>treatment_mean))</span>
<span id="cb6-385"><a href="#cb6-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-386"><a href="#cb6-386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create data frame for noborrow results</span></span>
<span id="cb6-387"><a href="#cb6-387" aria-hidden="true" tabindex="-1"></a>    noborrow_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-388"><a href="#cb6-388" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario =</span> scenario_name,</span>
<span id="cb6-389"><a href="#cb6-389" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_size =</span> n,</span>
<span id="cb6-390"><a href="#cb6-390" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"no borrowing"</span>,</span>
<span id="cb6-391"><a href="#cb6-391" aria-hidden="true" tabindex="-1"></a>      <span class="at">tau_prior =</span> <span class="cn">NA</span>,</span>
<span id="cb6-392"><a href="#cb6-392" aria-hidden="true" tabindex="-1"></a>      <span class="at">oc_estimate =</span> noborrow_significant,</span>
<span id="cb6-393"><a href="#cb6-393" aria-hidden="true" tabindex="-1"></a>      <span class="at">oc_type =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"null"</span>, scenario_name), <span class="st">"type1"</span>, <span class="st">"power"</span>),</span>
<span id="cb6-394"><a href="#cb6-394" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_tau =</span> <span class="cn">NA</span>,</span>
<span id="cb6-395"><a href="#cb6-395" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept_estimate =</span> noborrow_intercept,</span>
<span id="cb6-396"><a href="#cb6-396" aria-hidden="true" tabindex="-1"></a>      <span class="at">treatment_estimate =</span> noborrow_treatment</span>
<span id="cb6-397"><a href="#cb6-397" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-398"><a href="#cb6-398" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-399"><a href="#cb6-399" aria-hidden="true" tabindex="-1"></a>    results_list[[<span class="fu">length</span>(results_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> noborrow_df</span>
<span id="cb6-400"><a href="#cb6-400" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-401"><a href="#cb6-401" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-402"><a href="#cb6-402" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Then process dynamic results for all tau priors</span></span>
<span id="cb6-403"><a href="#cb6-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(n <span class="cf">in</span> sample_sizes) {</span>
<span id="cb6-404"><a href="#cb6-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(tau <span class="cf">in</span> tau_priors) {</span>
<span id="cb6-405"><a href="#cb6-405" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Get all results for this combination</span></span>
<span id="cb6-406"><a href="#cb6-406" aria-hidden="true" tabindex="-1"></a>      dynamic_results <span class="ot">&lt;-</span> scenario_results[<span class="fu">sapply</span>(scenario_results, <span class="cf">function</span>(x) </span>
<span id="cb6-407"><a href="#cb6-407" aria-hidden="true" tabindex="-1"></a>        x<span class="sc">$</span>sample_size <span class="sc">==</span> n <span class="sc">&amp;</span> x<span class="sc">$</span>tau_prior <span class="sc">==</span> tau)]</span>
<span id="cb6-408"><a href="#cb6-408" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-409"><a href="#cb6-409" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate means across simulations for dynamic</span></span>
<span id="cb6-410"><a href="#cb6-410" aria-hidden="true" tabindex="-1"></a>      dynamic_significant <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(dynamic_results, <span class="cf">function</span>(x) x<span class="sc">$</span>dynamic<span class="sc">$</span>significant))</span>
<span id="cb6-411"><a href="#cb6-411" aria-hidden="true" tabindex="-1"></a>      dynamic_mean_tau <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(dynamic_results, <span class="cf">function</span>(x) x<span class="sc">$</span>dynamic<span class="sc">$</span>mean_tau))</span>
<span id="cb6-412"><a href="#cb6-412" aria-hidden="true" tabindex="-1"></a>      dynamic_intercept <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(dynamic_results, <span class="cf">function</span>(x) x<span class="sc">$</span>dynamic<span class="sc">$</span>intercept_mean))</span>
<span id="cb6-413"><a href="#cb6-413" aria-hidden="true" tabindex="-1"></a>      dynamic_treatment <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">sapply</span>(dynamic_results, <span class="cf">function</span>(x) x<span class="sc">$</span>dynamic<span class="sc">$</span>treatment_mean))</span>
<span id="cb6-414"><a href="#cb6-414" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-415"><a href="#cb6-415" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create data frame for dynamic results</span></span>
<span id="cb6-416"><a href="#cb6-416" aria-hidden="true" tabindex="-1"></a>      dynamic_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-417"><a href="#cb6-417" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario =</span> scenario_name,</span>
<span id="cb6-418"><a href="#cb6-418" aria-hidden="true" tabindex="-1"></a>        <span class="at">sample_size =</span> n,</span>
<span id="cb6-419"><a href="#cb6-419" aria-hidden="true" tabindex="-1"></a>        <span class="at">method =</span> <span class="fu">paste0</span>(<span class="st">"BDB</span><span class="sc">\n</span><span class="st">  tau prior = dexp("</span>, tau, <span class="st">")"</span>),</span>
<span id="cb6-420"><a href="#cb6-420" aria-hidden="true" tabindex="-1"></a>        <span class="at">tau_prior =</span> tau,</span>
<span id="cb6-421"><a href="#cb6-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">oc_estimate =</span> dynamic_significant,</span>
<span id="cb6-422"><a href="#cb6-422" aria-hidden="true" tabindex="-1"></a>        <span class="at">oc_type =</span> <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"null"</span>, scenario_name), <span class="st">"type1"</span>, <span class="st">"power"</span>),</span>
<span id="cb6-423"><a href="#cb6-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">mean_tau =</span> dynamic_mean_tau,</span>
<span id="cb6-424"><a href="#cb6-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">intercept_estimate =</span> dynamic_intercept,</span>
<span id="cb6-425"><a href="#cb6-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">treatment_estimate =</span> dynamic_treatment</span>
<span id="cb6-426"><a href="#cb6-426" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-427"><a href="#cb6-427" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-428"><a href="#cb6-428" aria-hidden="true" tabindex="-1"></a>      results_list[[<span class="fu">length</span>(results_list) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> dynamic_df</span>
<span id="cb6-429"><a href="#cb6-429" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-430"><a href="#cb6-430" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-431"><a href="#cb6-431" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-432"><a href="#cb6-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-433"><a href="#cb6-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all results into one data frame</span></span>
<span id="cb6-434"><a href="#cb6-434" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results_list)</span>
<span id="cb6-435"><a href="#cb6-435" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(results_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s plot results.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#2C5F2D"</span>, <span class="st">"#97BC62"</span>, <span class="st">"#D68C45"</span>, <span class="st">"#C2B59B"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>results_df<span class="sc">$</span>scenario <span class="ot">&lt;-</span> <span class="fu">factor</span>(results_df<span class="sc">$</span>scenario, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"null_noconflict"</span>, <span class="st">"noconflict"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"null_noConflict_wideSE"</span>, <span class="st">"noConflict_wideSE"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"null_conflict_oppsign"</span>, <span class="st">"conflict_oppsign"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">"null_conflict_samesign"</span>, <span class="st">"conflict_samesign"</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"No Prior-Data Conflict"</span>, <span class="st">"Prior-Data Conflict — Opposite sign"</span>,<span class="st">"Prior-Data Conflict — Same sign"</span>, <span class="st">"No Prior-Data Conflict — Wide SD"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Power plot</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>labspwr <span class="ot">&lt;-</span> labs</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(labspwr) <span class="ot">&lt;-</span> <span class="fu">unique</span>(results_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(oc_type <span class="sc">==</span> <span class="st">"power"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(scenario))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(oc_type <span class="sc">==</span> <span class="st">"power"</span>), <span class="fu">aes</span>(<span class="at">x =</span> sample_size)) <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> oc_estimate, <span class="at">color =</span> method), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>scenario, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">scenario =</span> labspwr)) <span class="sc">+</span> </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.8</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.9</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span> </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Power"</span>) <span class="sc">+</span> </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Sample size"</span>) <span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Power"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bdb_blog_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Type 1 plot</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>labspval <span class="ot">&lt;-</span> labs</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(labspval) <span class="ot">&lt;-</span> <span class="fu">unique</span>(results_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(oc_type <span class="sc">==</span> <span class="st">"type1"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(scenario))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(results_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(oc_type <span class="sc">==</span> <span class="st">"type1"</span> <span class="sc">&amp;</span> sample_size <span class="sc">==</span> <span class="dv">100</span>), <span class="fu">aes</span>(<span class="at">x =</span> method)) <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> oc_estimate, <span class="at">color =</span> method), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>scenario, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">scenario =</span> labspval)) <span class="sc">+</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> colors) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.05</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Type 1 Error Rate"</span>) <span class="sc">+</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.15</span>)) <span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Type 1 Error Rate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="bdb_blog_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Take the upper-left panel first, where there’s no prior-data conflict. We see that BDB generally improves statistical power. For instance, under these particular conditions we reach a standard 90% power with a sample size of around 70-80 with the BDB models compared to just short of 100 for the model without borrowing – that is, a 20-30% reduction in sample size. The three BDB models have quite similar power, although the one with a higher mean prior on <span class="math inline">\(\tau\)</span>, <code>exponential(0.1)</code>, has slightly more power due to higher degree of borrowing. Note too that we can reap these gains in power without paying a cost in terms of Type I error – all models in the middle panel have similar Type I error rates and if anything the model without borrowing performs worst.</p>
<p>In the bottom-left panel, where we have prior-data conflict with the <em>opposite</em> sign as the true control mean, we see a similar picture for power: BDB models have higher power than the model without borrowing. But it’s more pronounced here. A likely explanation is that the influence of the historical data creates greater contrast between the estimated treatment and control groups, making the treatment effect easier to discern – while the dynamic borrowing models adaptively discount the historical data under conflict, it allows partial borrowing to still provide some information. However, this comes at the cost of inflated Type I error rates, where all BDB models are above the nominal threshold of 0.05. Whether the higher Type I error rates are acceptable given the substantial power gains can only be evaluated on a case by case basis. For instance, there are probably cases where it’s too expensive to miss a true effect, such that we’re willing to increase slightly the chance of a false positive to reduce the chance of a false negative.</p>
<p>In the bottom-right panel, where we have prior-data conflict with the <em>same</em> sign as the true control mean, the BDB models have less power than the model without borrowing. Following the same logic as with the opposite sign conflict scenario, this is because the borrowing process pulls the control group estimate toward the historical data, which shares the same sign but differs in magnitude. This effectively dilutes the contrast between the treatment and control groups. The Type I error rates in this scenario are inflated across all BDB models, though the inflation is less severe compared to the opposite sign conflict scenario. Both conflict scenarios, then, highlight the importance of identifying appropriate historical data sources for BDB to shine.</p>
<p>Finally, for the upper-right panel, where we have a wider standard deviation for the historical control data but no prior-data conflict, we see that the BDB models have similar power and Type I error rates to that of the model without borrowing. This is because the wider standard deviation in the historical control data weakens the influence of borrowing, which in turn reduces the impact of the prior on the posterior estimates. As a result, the dynamic borrowing models rely more heavily on the current data, making their behavior closer to that of the no-borrowing model.</p>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>This post introduced Bayesian Dynamic Borrowing using <code>R</code> and the <code>rethinking</code> package. As we’ve seen, BDB allows us to use informative priors, while letting the model figure out how much information to borrow from the prior. Given relevant prior information, BDB can help reduce sample size and costs of a trial as well as shorten study timelines. It’s particularly useful when study participants are hard to come by, for instance in rare diseases, pediatric populations, and regional studies.</p>
<p>To build intuition for BDB, we also ran a small simulation. This could be expanded in a number of ways, for instance by adding more scenarios and making it more computationally efficient. And of course, there’s also much more to BDB than we’ve covered here. For instance, we haven’t considered how to appropriately select historical data sources, derive meta-analytic priors, use individual-level data rather than summary statistics, or how BDB models perform with more complex data or designs – interested readers could check out <span class="citation" data-cites="novartisbook">Weber et al. (<a href="#ref-novartisbook" role="doc-biblioref">2025</a>)</span> as well as <span class="citation" data-cites="alt2025hdbayes">Alt et al. (<a href="#ref-alt2025hdbayes" role="doc-biblioref">2025</a>)</span>, <span class="citation" data-cites="psborrow2">Secrest and Gravestock (<a href="#ref-psborrow2" role="doc-biblioref">2025</a>)</span>, and <span class="citation" data-cites="rbest">Weber et al. (<a href="#ref-rbest" role="doc-biblioref">2021</a>)</span>. For further deep dives on BDB, some starting points include <span class="citation" data-cites="best2021assessing">Best et al. (<a href="#ref-best2021assessing" role="doc-biblioref">2021</a>)</span>, <span class="citation" data-cites="edwards2024using">Edwards et al. (<a href="#ref-edwards2024using" role="doc-biblioref">2024</a>)</span>, <span class="citation" data-cites="kaplan2023bayesian">Kaplan et al. (<a href="#ref-kaplan2023bayesian" role="doc-biblioref">2023</a>)</span>, <span class="citation" data-cites="hobbs2011hierarchical">Hobbs et al. (<a href="#ref-hobbs2011hierarchical" role="doc-biblioref">2011</a>)</span>, and <span class="citation" data-cites="viele2014use">Viele et al. (<a href="#ref-viele2014use" role="doc-biblioref">2014</a>)</span>.</p>
<p>Personally, I find it intellectually – even philosophically – satisfying to actually make use of historical information whenever possible, aligning well with an ideal of science as a cumulative endeavor. As such, BDB paves a way to be Bayesian in a frequentist world.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-alt2025hdbayes" class="csl-entry" role="listitem">
Alt, Ethan M, Xinxin Chen, Luiz M Carvalho, and Joseph G Ibrahim. 2025. <span>“Hdbayes: An r Package for Bayesian Analysis of Generalized Linear Models Using Historical Data.”</span> <em>arXiv Preprint arXiv:2506.20060</em>.
</div>
<div id="ref-best2021assessing" class="csl-entry" role="listitem">
Best, Nicky, Robert G Price, Isabelle J Pouliquen, and Oliver N Keene. 2021. <span>“Assessing Efficacy in Important Subgroups in Confirmatory Trials: An Example Using Bayesian Dynamic Borrowing.”</span> <em>Pharmaceutical Statistics</em> 20 (3): 551–62.
</div>
<div id="ref-burkner2017brms" class="csl-entry" role="listitem">
Bürkner, Paul-Christian. 2017. <span>“Brms: An r Package for Bayesian Multilevel Models Using Stan.”</span> <em>Journal of Statistical Software</em> 80: 1–28.
</div>
<div id="ref-carpenter2017stan" class="csl-entry" role="listitem">
Carpenter, Bob, Andrew Gelman, Matthew D Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. <span>“Stan: A Probabilistic Programming Language.”</span> <em>Journal of Statistical Software</em> 76: 1–32.
</div>
<div id="ref-edwards2024using" class="csl-entry" role="listitem">
Edwards, Dawn, N Best, J Crawford, L Zi, C Shelton, and A Fowler. 2024. <span>“Using Bayesian Dynamic Borrowing to Maximize the Use of Existing Data: A Case-Study.”</span> <em>Therapeutic Innovation &amp; Regulatory Science</em> 58 (1): 1–10.
</div>
<div id="ref-bda3" class="csl-entry" role="listitem">
Gelman, Andrew, John B Carlin, Dunson Stern Hal S, and Donald B Rubin. 2013. <em>Bayesian Data Analysis</em>. 3rd ed. Chapman; Hall/CRC.
</div>
<div id="ref-rstanarm" class="csl-entry" role="listitem">
Goodrich, Ben, Jonah Gabry, Imad Ali, and Sam Brilleman. 2024. <span>“Rstanarm: <span>Bayesian</span> Applied Regression Modeling via <span>Stan</span>.”</span> <a href="https://mc-stan.org/rstanarm/">https://mc-stan.org/rstanarm/</a>.
</div>
<div id="ref-hobbs2011hierarchical" class="csl-entry" role="listitem">
Hobbs, Brian P, Bradley P Carlin, Sumithra J Mandrekar, and Daniel J Sargent. 2011. <span>“Hierarchical Commensurate and Power Prior Models for Adaptive Incorporation of Historical Information in Clinical Trials.”</span> <em>Biometrics</em> 67 (3): 1047–56.
</div>
<div id="ref-kaplan2023bayesian" class="csl-entry" role="listitem">
Kaplan, David, Jianshen Chen, Sinan Yavuz, and Weicong Lyu. 2023. <span>“Bayesian Dynamic Borrowing of Historical Information with Applications to the Analysis of Large-Scale Assessments.”</span> <em>Psychometrika</em> 88 (1): 1–30.
</div>
<div id="ref-mcelreath_statistical_2020" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical <span>Rethinking</span>: <span>A</span> <span>Bayesian</span> Course with Examples in <span>R</span> and <span>Stan</span></em>. Second. CRC Press.
</div>
<div id="ref-rcoreteam2024" class="csl-entry" role="listitem">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-psborrow2" class="csl-entry" role="listitem">
Secrest, Matt, and Isaac Gravestock. 2025. <em>Psborrow2: Bayesian Dynamic Borrowing Analysis and Simulation</em>. <a href="https://github.com/Genentech/psborrow2">https://github.com/Genentech/psborrow2</a>.
</div>
<div id="ref-viele2014use" class="csl-entry" role="listitem">
Viele, Kert, Scott Berry, Beat Neuenschwander, Billy Amzal, Fang Chen, Nathan Enas, Brian Hobbs, et al. 2014. <span>“Use of Historical Control Data for Assessing Treatment Effects in Clinical Trials.”</span> <em>Pharmaceutical Statistics</em> 13 (1): 41–54.
</div>
<div id="ref-novartisbook" class="csl-entry" role="listitem">
Weber, Sebastian, Björn Holzhauer, Lukas Widmer, and Andrew Bean. 2025. <em>Applied Modelling in Drug Development: <span>F</span>lexible Regression Modelling in <span>Stan</span> via Brms</em>. <a href="https://opensource.nibr.com/bamdd/">https://opensource.nibr.com/bamdd/</a>.
</div>
<div id="ref-rbest" class="csl-entry" role="listitem">
Weber, Sebastian, Yue Li, John W. Seaman, Tomoyuki Kakizume, and Heinz Schmidli. 2021. <span>“Applying Meta-Analytic-Predictive Priors with the <span>R</span> <span>B</span>ayesian Evidence Synthesis Tools.”</span> <em>Journal of Statistical Software</em> 100 (19): 1–32. <a href="https://doi.org/10.18637/jss.v100.i19">https://doi.org/10.18637/jss.v100.i19</a>.
</div>
</div>
</section>
<section id="session-info" class="level1">
<h1>Session info</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.1 (2024-06-14)
Platform: x86_64-pc-linux-gnu
Running under: Rocky Linux 8.10 (Green Obsidian)

Matrix products: default
BLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: Europe/Copenhagen
tzcode source: system (glibc)

attached base packages:
[1] parallel  stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
[1] dplyr_1.1.4         tidybayes_3.0.6     ggplot2_3.5.1      
[4] digest_0.6.36       rethinking_2.42     posterior_1.6.0    
[7] cmdstanr_0.9.0.9000

loaded via a namespace (and not attached):
 [1] gtable_0.3.5         shape_1.4.6.1        tensorA_0.36.2.1    
 [4] QuickJSR_1.3.1       xfun_0.46            htmlwidgets_1.6.4   
 [7] processx_3.8.4       inline_0.3.19        lattice_0.22-6      
[10] vctrs_0.6.5          tools_4.4.1          ps_1.7.7            
[13] generics_0.1.3       curl_5.2.1           stats4_4.4.1        
[16] tibble_3.2.1         fansi_1.0.6          pkgconfig_2.0.3     
[19] Matrix_1.7-0         data.table_1.15.4    checkmate_2.3.2     
[22] assertthat_0.2.1     RcppParallel_5.1.8   distributional_0.4.0
[25] lifecycle_1.0.4      compiler_4.4.1       farver_2.1.2        
[28] munsell_0.5.1        codetools_0.2-20     htmltools_0.5.8.1   
[31] yaml_2.3.10          Formula_1.2-5        pillar_1.9.0        
[34] tidyr_1.3.1          arrayhelpers_1.1-0   MASS_7.3-61         
[37] StanHeaders_2.32.10  RBesT_1.7-3          abind_1.4-5         
[40] rstan_2.32.6         tidyselect_1.2.1     svUnit_1.0.6        
[43] mvtnorm_1.2-5        purrr_1.0.2          labeling_0.4.3      
[46] fastmap_1.2.0        grid_4.4.1           colorspace_2.1-1    
[49] cli_3.6.3            magrittr_2.0.3       loo_2.8.0           
[52] pkgbuild_1.4.4       utf8_1.2.4           withr_3.0.1         
[55] scales_1.3.0         backports_1.5.0      lubridate_1.9.3     
[58] timechange_0.3.0     rmarkdown_2.27       matrixStats_1.3.0   
[61] gridExtra_2.3        coda_0.19-4.1        evaluate_0.24.0     
[64] knitr_1.48           V8_4.4.2             ggdist_3.3.2        
[67] rstantools_2.4.0     rlang_1.1.4          Rcpp_1.0.13         
[70] glue_1.7.0           rstudioapi_0.16.0    jsonlite_1.8.8      
[73] R6_2.5.1            </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>
